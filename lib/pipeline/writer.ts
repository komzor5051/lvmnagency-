import { generatePro } from "@/lib/gemini";
import { Source } from "@/lib/researcher";
import { supabase } from "@/lib/supabase";
import { LVMN_STYLE_GUIDE } from "./style-guide";
import { LVMN_FEATURES } from "@/lib/lvmn-features";

interface WriterInput {
  title: string;
  angle: string;
  keywords: string[];
  sources: Source[];
}

async function getExistingArticles(): Promise<string> {
  const { data } = await supabase
    .from("lvmn_blog_posts")
    .select("title, slug")
    .eq("status", "published")
    .order("published_at", { ascending: false })
    .limit(30);

  if (!data || data.length === 0) return "";

  return data
    .map((p) => `- [${p.title}](/blog/${p.slug})`)
    .join("\n");
}

export async function writeArticle(input: WriterInput): Promise<string> {
  const sourcesContext = input.sources
    .map((s) => `[${s.title}](${s.url}): ${s.summary}`)
    .join("\n\n");

  const existingArticles = await getExistingArticles();

  const today = new Date().toLocaleDateString("ru-RU", {
    year: "numeric", month: "long", day: "numeric",
  });

  const internalLinksBlock = existingArticles
    ? `\nВНУТРЕННИЕ ССЫЛКИ (ОБЯЗАТЕЛЬНО):
Вот список уже опубликованных статей в нашем блоге:
${existingArticles}

Правила внутренней перелинковки:
- Вставь 2-4 ссылки на релевантные статьи из списка выше ЕСТЕСТВЕННО по тексту
- Ссылки должны быть органичными: "как мы писали в статье [название](url)" или "подробнее об этом — в [название](url)"
- НЕ ссылайся на статью, если она не связана с темой
- НЕ вставляй все ссылки в одно место — распредели по тексту
- Используй ТОЧНЫЕ URL из списка, не выдумывай\n`
    : "";

  const prompt = `Ты автор блога AI-агентства LVMN. Пишешь живым русским языком, как практик.

Дата: ${today}

Напиши статью на тему: "${input.title}"
Угол раскрытия: ${input.angle}
SEO-ключевые слова (встрой естественно): ${input.keywords.join(", ")}

Источники для фактов и ссылок:
${sourcesContext}

${LVMN_STYLE_GUIDE}

ОБ АГЕНТСТВЕ LVMN (используй ТОЛЬКО эту информацию, НЕ выдумывай услуги):
${LVMN_FEATURES}

СТРУКТУРА ЗАГОЛОВКОВ (СТРОГО):
- Заголовок статьи НЕ НУЖЕН (он будет добавлен отдельно как H1)
- Используй ## (H2) для основных секций
- Используй ### (H3) для подсекций внутри H2
- НИКОГДА не пропускай уровни (нет H3 без родительского H2)
- Каждый H2 должен быть информативным, содержать ключевое слово
${internalLinksBlock}
КАРТИНКИ-МЕМЫ (ОБЯЗАТЕЛЬНО):
Вставляй 2-3 мемных картинки по всей статье в формате:
![MEME: описание картинки на русском](placeholder)

Правила для картинок:
- Первая картинка — сразу после первого абзаца (будет cover image)
- Вторая — примерно в середине статьи
- Третья (если есть) — ближе к концу, перед CTA
- Описание должно быть КОНКРЕТНЫМ: кто, что делает, какой текст на картинке
- Текст на картинке — на РУССКОМ, короткий (5-10 слов), мемный
- Стиль: смешные ситуации из мира ИИ и автоматизации бизнеса
- НЕ БОЛЬШЕ 3 картинок!

ПРОМПТЫ И КОМАНДЫ (ВАЖНО):
- Когда приводишь примеры промптов, команд или текстов для копирования — оформляй их в блоках кода (тройные бэктики \`\`\`)
- НЕ используй инлайн-код (одинарные бэктики) для длинных промптов

ОБЯЗАТЕЛЬНЫЕ ССЫЛКИ:
- Ссылка на сайт агентства: [LVMN](https://lvmn.vercel.app) — вставь естественно, когда к месту
- CTA-ссылка: [Написать в Telegram](https://t.me/lyaminvl?text=Аудит)

СТРУКТУРА СТАТЬИ:
1. Хук — 1-2 цепляющих предложения (проблема, вопрос, провокация)
2. Краткий пересказ — сразу после хука напиши 2-3 предложения "В этой статье: ..." чтобы человек понял, стоит ли читать
3. Основная часть — пошагово, с примерами и кейсами
4. Секция "Как мы это решаем в LVMN" — конкретный пример из практики агентства
5. CTA: "Напишите «Аудит» в Telegram — разберём ваш бизнес и предложим конкретное решение" со ссылкой https://t.me/lyaminvl?text=Аудит

Требования:
- 1500-2500 слов
- Формат Markdown
- Ссылки на источники в тексте
- Язык — простой, живой, экспертный. Объясняй на пальцах, с конкретными цифрами.
- Пиши "ИИ", не "AI" (кроме устоявшихся терминов вроде "AI-продукт").

Напиши ТОЛЬКО статью в Markdown, без вступления от себя.`;

  return generatePro(prompt);
}
